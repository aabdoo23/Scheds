name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: windows-latest  # Windows has MSDeploy built-in
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Scheds/Scheds.MVC.csproj
    
    - name: Build
      run: dotnet build Scheds/Scheds.MVC.csproj -c Release --no-restore
    
    - name: Update Production Configuration
      shell: pwsh
      run: |
        $prodSettings = @{
          FrontendSettings = @{
            Url = "${{ secrets.FRONTEND_URL }}"
          }
          ConnectionStrings = @{
            SqlServerConnection = "${{ secrets.PROD_CONNECTION_STRING }}"
          }
          AdminSettings = @{
            Password = "${{ secrets.PROD_ADMIN_PASSWORD }}"
          }
          Logging = @{
            LogLevel = @{
              Default = "Warning"
              "Microsoft.AspNetCore" = "Warning"
            }
          }
          Authentication = @{
            Google = @{
              ClientId = "${{ secrets.GOOGLE_CLIENT_ID }}"
            }
          }
          Smtp = @{
            Host = "smtp.gmail.com"
            Port = [int]"${{ secrets.SMTP_PORT }}"
            EnableSsl = $true
            User = "${{ secrets.SMTP_USER }}"
            Password = "${{ secrets.SMTP_PASSWORD }}"
            From = "${{ secrets.SMTP_FROM }}"
          }
          AllowedHosts = "*"
        }
        
        $prodSettings | ConvertTo-Json -Depth 10 | Out-File -FilePath "Scheds/appsettings.json" -Encoding UTF8
    
    - name: Create publish profile
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path Scheds/Properties/PublishProfiles
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
          <PropertyGroup>
            <WebPublishMethod>MSDeploy</WebPublishMethod>
            <PublishProvider>AzureWebSite</PublishProvider>
            <LastUsedBuildConfiguration>Release</LastUsedBuildConfiguration>
            <LastUsedPlatform>Any CPU</LastUsedPlatform>
            <SiteUrlToLaunchAfterPublish>http://scheds.runasp.net/</SiteUrlToLaunchAfterPublish>
            <MSDeployServiceURL>site8805.siteasp.net</MSDeployServiceURL>
            <DeployIisAppPath>site8805</DeployIisAppPath>
            <SkipExtraFilesOnServer>False</SkipExtraFilesOnServer>
            <MSDeployPublishMethod>WMSVC</MSDeployPublishMethod>
            <EnableMSDeployBackup>True</EnableMSDeployBackup>
            <UserName>${{ secrets.DEPLOY_USERNAME }}</UserName>
            <Password>${{ secrets.DEPLOY_PASSWORD }}</Password>
            <TargetFramework>net9.0</TargetFramework>
            <SelfContained>false</SelfContained>
          </PropertyGroup>
        </Project>
        "@ | Out-File -FilePath Scheds/Properties/PublishProfiles/Production.pubxml -Encoding UTF8
    
    - name: Deploy to Production
      run: dotnet publish Scheds/Scheds.MVC.csproj -c Release /p:PublishProfile=Production /p:Password="${{ secrets.DEPLOY_PASSWORD }}"
      env:
        DEPLOY_USERNAME: ${{ secrets.DEPLOY_USERNAME }}
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
