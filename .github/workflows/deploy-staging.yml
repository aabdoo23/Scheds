name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore Scheds/Scheds.sln

    - name: Build
      run: dotnet build Scheds/Scheds.sln -c Release --no-restore

    - name: Update Staging Configuration
      shell: pwsh
      run: |
        $stagingSettings = @{
          FrontendSettings = @{
            Url = "${{ secrets.STAGING_FRONTEND_URL }}"
          }
          ConnectionStrings = @{
            SqlServerConnection = "${{ secrets.STAGING_CONNECTION_STRING }}"
          }
          AdminSettings = @{
            Password = "${{ secrets.PROD_ADMIN_PASSWORD }}"
          }
          Logging = @{
            LogLevel = @{
              Default = "Warning"
              "Microsoft.AspNetCore" = "Warning"
            }
          }
          Authentication = @{
            Google = @{
              ClientId = "${{ secrets.GOOGLE_CLIENT_ID }}"
            }
          }
          Smtp = @{
            Host = "smtp.gmail.com"
            Port = [int]"${{ secrets.SMTP_PORT }}"
            EnableSsl = $true
            User = "${{ secrets.SMTP_USER }}"
            Password = "${{ secrets.SMTP_PASSWORD }}"
            From = "${{ secrets.SMTP_FROM }}"
          }
          AllowedHosts = "*"
          ExposeApiErrors = $true
          UseCrossOriginCookies = $true
          Jwt = @{
            Key = "${{ secrets.JWT_SECRET_KEY }}"
            Issuer = "scheds"
            Audience = "scheds-frontend"
            ExpirationMinutes = 60
          }
        }

        $stagingSettings | ConvertTo-Json -Depth 10 | Out-File -FilePath "Scheds/appsettings.json" -Encoding UTF8

    - name: Install EF Core tools
      run: dotnet tool install --global dotnet-ef --version 9.*

    - name: Run database migrations
      run: dotnet ef database update --project Scheds.Infrastructure/Scheds.Infrastructure.csproj --startup-project Scheds/Scheds.MVC.csproj --configuration Release --no-build

    - name: Create publish profile
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path Scheds/Properties/PublishProfiles
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
          <PropertyGroup>
            <WebPublishMethod>MSDeploy</WebPublishMethod>
            <PublishProvider>AzureWebSite</PublishProvider>
            <LastUsedBuildConfiguration>Release</LastUsedBuildConfiguration>
            <LastUsedPlatform>Any CPU</LastUsedPlatform>
            <SiteUrlToLaunchAfterPublish>http://scheds-staging.runasp.net/</SiteUrlToLaunchAfterPublish>
            <MSDeployServiceURL>site52819.siteasp.net</MSDeployServiceURL>
            <DeployIisAppPath>site52819</DeployIisAppPath>
            <SkipExtraFilesOnServer>False</SkipExtraFilesOnServer>
            <MSDeployPublishMethod>WMSVC</MSDeployPublishMethod>
            <EnableMSDeployBackup>True</EnableMSDeployBackup>
            <UserName>${{ secrets.STAGING_DEPLOY_USERNAME }}</UserName>
            <Password>${{ secrets.STAGING_DEPLOY_PASSWORD }}</Password>
            <TargetFramework>net9.0</TargetFramework>
            <SelfContained>false</SelfContained>
          </PropertyGroup>
        </Project>
        "@ | Out-File -FilePath Scheds/Properties/PublishProfiles/Staging.pubxml -Encoding UTF8

    - name: Deploy to Staging
      run: dotnet publish Scheds/Scheds.MVC.csproj -c Release /p:PublishProfile=Staging /p:Password="${{ secrets.STAGING_DEPLOY_PASSWORD }}"
      env:
        DEPLOY_USERNAME: ${{ secrets.STAGING_DEPLOY_USERNAME }}
        DEPLOY_PASSWORD: ${{ secrets.STAGING_DEPLOY_PASSWORD }}
